
####  Global parameters
set Dimension                              = 2
set Start time                             = 0
set End time                               = 5e6
set Use years in output instead of seconds = true
set Nonlinear solver scheme                = iterated Advection and Stokes
set Nonlinear solver tolerance             = 1e-3 # Stricter tolerances should be tested
set Max nonlinear iterations               = 10 # Normally this should be set to a higher number
set CFL number                             = 0.2
set Maximum time step                      = 20e3
set Output directory                       = output-2d_fs_sea_level
set Pressure normalization                 = no

subsection Solver parameters
  subsection Stokes solver parameters
    set Stokes solver type = block AMG
    set Number of cheap Stokes solver steps = 4000
    set Linear solver tolerance             = 1e-7
  end
end

# Governing equations
subsection Formulation
  set Formulation = Boussinesq approximation
end

subsection Discretization
  set Composition polynomial degree           = 2
  set Stokes velocity polynomial degree       = 2
  set Temperature polynomial degree           = 2
end

# Model geometry (200x100 km, 20 km spacing)
subsection Geometry model
  set Model name = box
  subsection Box
    set X repetitions = 6
    set Y repetitions = 1
    set X extent      = 60e3
    set Y extent      = 10e3
  end
end

# Globally refine the mesh to 2.5 km spacing, and then
# adaptively refine the mesh to 1.25 km spacing above y=50 km
# and between x=40 and x=160 km. These values ensure areas
# undergoing brittle deformation are in the high-resolution
# region.
subsection Mesh refinement
  set Initial adaptive refinement        = 2
  set Initial global refinement          = 3
  set Time steps between mesh refinement = 0
  set Strategy = minimum refinement function
  subsection Minimum refinement function
    set Coordinate system   = cartesian
    set Variable names      = x,y
    set Function expression = if ( y>=7e3, 5, if(y>=4e3, 4, 3))
  end
end

subsection Mesh deformation
  set Mesh deformation boundary indicators        = top: fastscape
  set Additional tangential mesh velocity boundary indicators = left, right 

  subsection Fastscape
    set Number of fastscape timesteps per aspect timestep = 5
    set Maximum timestep length = 5000
    set Vertical exaggeration = -1
    set Additional fastscape refinement = 1
    set Average out of plane surface topography in 2d = true
    set Fastscape seed = 1000
    set Maximum surface refinement level = 3
    set Surface refinement difference = 0
    set Use marine component = true
    # FastScape Y extent when using a 2D ASPECT model
    set Y extent in 2d = 50e3
    set Uplift and advect with fastscape = true
    set Use ghost nodes = true
    set Node tolerance = 0.001
    set Fastscape seed = 1000

   subsection Boundary conditions    
      set Front = 1 # fixed
      set Right  = 0 # reflective
      set Back = 1
      set Left   = 0
   end
   
   subsection Erosional parameters
     set Drainage area exponent = 0.5
     set Slope exponent = 1
     # A negative value indicates varied flow. 10 is steepest descent, and 1 is uniform distribution.
     #set Multi-direction slope exponent = -1
     # Bedrock deposition coefficient. Higher values deposit more sediment
     set Bedrock deposition coefficient = 1
     # Deposition coefficient for sediment, -1 sets this to teh same as the bedrock deposition coefficient
     set Sediment deposition coefficient = 1
     # River incision rate for bedrock in the Stream Power Law
     set Bedrock river incision rate = 2e-6
     # River incision rate for sediment in the Stream Power Law. -1 sets this to the bedrock river incision rate
     set Sediment river incision rate = 2e-6
     # Transport coefficient (diffusivity) for bedrock
     set Bedrock diffusivity = -1
     # Transport coefficient (diffusivity) for sediment. -1 sets this to the bedrock diffusivity
     set Sediment diffusivity = -1
     #set Use a fixed erosional base level = true
     #set Erosional base level = -5000
   end

   subsection Marine parameters
   # Fastscape sea level (m), set relative to the ASPECT surface where
   # a sea level of zero will represent the maximum Y (2D) or Z (3D) extent inside ASPECT.
     set Sea level = -2000
     set Use sea level function = true
     subsection Sea level function
       set Variable names = t
       set Function expression = -1e-3*t
     end 
     # sand_surface_porosity
     set Sand porosity = 0
     # Porosity of silt
     set Silt porosity = 0
     # E-folding depth for the exponential of the sand porosity law
     set Sand e-folding depth = 1e3
     # E-folding depth for the exponential of the silt porosity law
     set Silt e-folding depth = 1e3
     # Ratio of sand to silt for material leaving continent
     set Sand-silt ratio = 1  
     # Depth averaging for the sand-silt equation
     set Depth averaging thickness = 1e2
     # Transport coefficient (diffusivity) for sand
     set Sand transport coefficient = 10
     set Silt transport coefficient = 10
   end
 end
end  

# Velocity on boundaries characterized by functions
# The outward velocity (x-direction) on the left and right walls is 0.25 cm/year
# The vertical velocity at the base is 0.25 cm/year (balances outflow on sides)
# Velocity components parallel to the base (x-velocity) and side walls (y-velocity)
# are unconstrained (i.e. 'free').
subsection Boundary velocity model
  set Prescribed velocity boundary indicators = left x: function, right x:function, bottom y:function

  subsection Function
    set Variable names      = x,y
    set Function constants  = v=0.002, w=60.e3, d=10.e3
    set Function expression = if (x < w/2 , -v, v) ; v*2*d/w
  end
end

subsection Compositional fields
  set Number of fields = 6
  set Names of fields  = plastic_strain, \
                         noninitial_plastic_strain, \
                         crust_upper, \
                         sediment_age, \
                         deposition_depth, \
                         sediment
  set Types of fields = strain, \
                        strain, \
                        chemical composition, \
                        generic, \
                        generic, \
                        chemical composition
 
  set Compositional field methods = particles
  set Mapped particle properties  = plastic_strain: plastic_strain, \
                                    noninitial_plastic_strain: noninitial_plastic_strain, \
                                    crust_upper: initial crust_upper, \
                                    sediment_age: initial sediment_age, \
                                    deposition_depth: initial deposition_depth, \
                                    sediment: initial sediment
end

subsection Initial composition model
  set Model name = function

  subsection Function
    set Variable names      = x,y
    set Function constants  = factor=1.,depth=10.e3,ymax=10.e3,tandip=1.732,xf=20.e3,fthick=2.e3, fte = 3
    set Function expression = if((-tandip*(x-fthick)+ymax+xf*tandip>y) && (-tandip*x+ymax+xf*tandip<y) && y>ymax-depth, fte, \
                              if(x>20.e3 && x<40.e3 && y>ymax-depth, 0.5*factor*(0.2 + rand()), 0)); \
                              0; 1; 0; 0; 0;
  end
end

# Composition: fixed on bottom (inflow boundary), free on sides and top
subsection Boundary composition model
  set Model name = function
  set Fixed composition boundary indicators = top, bottom
  set Allow fixed composition on outflow boundaries = true
  subsection Function
    set Coordinate system   = cartesian
    set Variable names      = x,y,t
    set Function constants  = DZ = 10e3, SeaLevel = -1000  #  Attention: 2D setup only. Make sure to update these parameters according to box size and fastscape parameters. 
    set Function expression = 0; \
                              0; \
                              0; \
                              if(y>7e3, t/1e6, 0); \
                              if(y>7e3, DZ - SeaLevel -y, 0); \
                              if(y>7e3, 1, 0)
  end
end

# Temperature boundary conditions
# Top and bottom (fixed) temperatures are consistent with the initial temperature field
# Note that while temperatures are specified for the model sides, these values are
# not used as the sides are not specified "Fixed temperature boundaries".  Rather,
# these boundaries are insulating (zero net heat flux).
subsection Boundary temperature model
  set Fixed temperature boundary indicators = bottom, top, left, right
  set List of model names = initial temperature
end
# Temperature initial conditions (isothermal)
subsection Initial temperature model
  set Model name = function

  subsection Function
    set Function expression = 293
  end
end


# Material model
# Rheology: Non-linear viscous flow and Drucker Prager Plasticity
# Values for most rheological parameters are specified for a background material and
# each compositional field.  Values for viscous deformation are based on dislocation
# creep flow-laws, with distinct values for the upper crust (wet quartzite), lower
# crust (wet anorthite) and mantle (dry olivine).  Table 1 of Naliboff and Buiter (2015),
# Earth Planet. Sci. Lett., v.421, p. 58-67 contains values for each of these flow laws.
subsection Material model
  set Model name = visco plastic

  set Material averaging = harmonic average

  subsection Visco Plastic

    # Reference temperature and viscosity
    set Reference temperature = 293

    # The minimum strain-rate helps limit large viscosities values that arise
    # as the strain-rate approaches zero.
    # The reference strain-rate is used on the first non-linear iteration
    # of the first time step when the velocity has not been determined yet.
    set Minimum strain rate = 1.e-20
    set Reference strain rate = 1.e-16

    # Limit the viscosity with minimum and maximum values
    set Minimum viscosity = 1e18
    set Maximum viscosity = 1e26

    # Thermal diffusivity is adjusted to match thermal conductivities
    # assumed in assigning the initial geotherm
    set Define thermal conductivities = true
    set Thermal conductivities        = 2.5
    set Heat capacities               = 750.

    # Density values of 1 are assigned to "strain" fields, which are not taken into
    # account when computing material properties.
    set Densities                     = background: 3300, \
                                        sediment: 2100, \
                                        crust_upper: 2700, \


    set Thermal expansivities         = 2e-5

    # Harmonic viscosity averaging
    set Viscosity averaging scheme = harmonic
    set Viscous flow law = dislocation

    set Prefactors for dislocation creep          = background: 7.37e-15, \
                                                    sediment: 1.37e-26, \
                                                    crust_upper: 1.37e-26, \

    set Stress exponents for dislocation creep    = background: 3.5, \
                                                    sediment: 4.0, \
                                                    crust_upper: 4.0, \

    set Activation energies for dislocation creep = background: 530.e3, \
                                                    sediment: 223.e3, \
                                                    crust_upper: 223.e3, \
                                                  

    set Activation volumes for dislocation creep  = background: 18.e-6, \
                                                    sediment: 0, \
                                                    crust_upper: 0, \
                                                    
    # Plasticity parameters
    set Angles of internal friction = 30
    set Cohesions                   = 20.e6

    # The parameters below weaken the friction and cohesion by a
    # a factor of 4 between plastic strain values of 0.5 and 1.5.
    set Strain weakening mechanism                   = plastic weakening with plastic strain only
    set Start plasticity strain weakening intervals  = 0.5
    set End plasticity strain weakening intervals    = 1.5
    set Cohesion strain weakening factors            = 0.0625
    set Friction strain weakening factors            = 0.0625

    set Use plastic damper       = true
    set Plastic damper viscosity = 1e21

  end
end

# Gravity model
subsection Gravity model
  set Model name = vertical

  subsection Vertical
    set Magnitude = 9.81
  end
end

subsection Particles
  set Minimum particles per cell  = 25
  set Maximum particles per cell  = 100
  set Load balancing strategy     = remove and add particles
  set List of particle properties = initial composition, viscoplastic strain invariants, pT path, position
  set Interpolation scheme        = bilinear least squares
  set Update ghost particles      = true
  set Particle generator name     = reference cell
  subsection Generator
    subsection Reference cell
      set Number of particles per cell per direction = 7
    end
  end
end


# Post processing
subsection Postprocess
  set List of postprocessors = basic statistics, composition statistics, heat flux densities, heat flux statistics, mass flux statistics, particles, pressure statistics, temperature statistics, topography, velocity statistics, visualization
  subsection Visualization
    set List of output variables = heat flux map, material properties, named additional outputs, strain rate
    subsection Material properties
      set List of material properties = density, viscosity
    end
    set Output format = vtu
    set Time between graphical output = 500.e3
    set Interpolate output            = true
    set Write higher order output     = true
    set Output format                 = vtu
  end
  subsection Particles
    set Time between data output    = 5e6
    set Data output format          = vtu
  end
end

# Checkpointing
subsection Checkpointing
  set Steps between checkpoint = 10
end


